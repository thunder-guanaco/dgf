{% load sekizai_tags static i18n dgf dgf_cms %}

{% addtoblock "css" %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/tour_results.css' %}">
{% endaddtoblock %}

{% with instance.tour as tour %}
{% with tour.tournaments.all|order_by:"begin" as tournaments %}
{% with tour|all_results as results %}
{% with results|all_friends as all_friends %}

{% comment %} This piece of HTML code is just generated to be appended in other places {% endcomment %}
{% for friend in all_friends %}
    <div id="friend-ball-{{friend.id}}" style="display:none;">
        {% include "dgf/includes/friend_ball.html" with friend=friend show_name=True %}
    </div>
{% endfor %}

<script>
    $(window).on("load", function() {
        console.log("Generating results table...");
        friends = parseData();
        generateTable(friends);
        console.log("Results table was generated");
    });

    function parseData() {
        friends = [
        {% for friend_results in results %}
            {
                id: {{friend_results.friend}},
                results: getBestResults({{friend_results|json|safe}}, {{tour.evaluate_how_many}})
            },
        {% endfor %}
        ];
        friends.sort(function(a, b) {
            return b.results.total - a.results.total;
        });
        return friends;
    }

    function getBestResults(results, amount) {

        var sortable = [];
        for (var key in results) {
            if (key.startsWith("points_")) {
                sortable.push([key, results[key]]);
            }
        }
        sortable.sort(function(a, b) {
            return negativeIfNull(b[1]) - negativeIfNull(a[1]);
        });

        var bestResults = {}
        var total = 0;
        sortable.forEach(function(item, index){
            tournamentId = item[0].split("_")[1];
            points = item[1]
            position = results["position_" + tournamentId]

            if (points == null) {
                points = '-';
            }
            else if (index < amount) {
                total += points;
            }
            else {
                points = "[" + points + "]";
                position = "X";
            }
            bestResults[tournamentId] = {"points": points, "position": position};
        })
        bestResults.total = total;
        return bestResults;
    }

    function negativeIfNull(x) {
        return x == null ? -1 : x;
    }

    function generateTable(friends) {
        var tbody = document.getElementsByTagName("tbody")[0];

        friends.forEach(function(friend, index) {

            var row = document.createElement("tr");

            addCell(row, "th", ["top"], index + 1);
            addFriendBall(row, "th", ["top"], friend.id);

            {% if request.user_agent.is_mobile %}
                cell = addCell(row, "th", ["top", "link"], friend.results.total);
                cell.onclick = function () {
                    $(this).parent().next().toggleClass("hidden");
                    $(this).parent().next().next().toggleClass("hidden");
                };

            {% else %}
                addCell(row, "th", ["top"], friend.results.total);

                // tournament results for DESKTOP
                {% for tournament in tournaments %}
                    result = friend.results[{{tournament.id}}]
                    addCell(row, "td", ["position_" + result.position], result.points);
                {% endfor %}
            {% endif %}

            tbody.appendChild(row);

            // tournament results for MOBILE
            {% if request.user_agent.is_mobile %}

                var header_row = document.createElement("tr");
                var points_row = document.createElement("tr");

                header_row.classList.add("tournament-results-row");
                points_row.classList.add("tournament-results-row");
                header_row.classList.add("hidden");
                points_row.classList.add("hidden");

                {% for tournament in tournaments %}
                    {% if tournament.url %}
                        addCellWithLink(header_row, "th", [], "{{tournament|ts_number}}", "_blank", "{{tournament.url}}");
                    {% else %}
                        addCell(header_row, "th", [], "{{tournament|ts_number}}");
                    {% endif %}
                    result = friend.results[{{tournament.id}}]
                    addCell(points_row, "td", ["position_" + result.position], result.points);
                {% endfor %}

                tbody.appendChild(header_row);
                tbody.appendChild(points_row);

            {% endif %}

        });
        $("table").fadeIn(500);
    }

    function addCell(row, type, classes, text) {
        var cell = document.createElement(type);
        classes.forEach(function(item){
            cell.classList.add(item);
        });

        var textNode = document.createTextNode(text);

        cell.appendChild(textNode);
        row.appendChild(cell);

        return cell;
    }

    function addFriendBall(row, type, classes, friend_id) {
        var cell = document.createElement(type);
        classes.forEach(function(item){
            cell.classList.add(item);
        });

        var ball = $("#friend-ball-" + friend_id)[0];
        $(ball).show();

        cell.appendChild(ball);
        row.appendChild(cell);

        return cell;
    }

    function addCellWithLink(row, type, classes, text, target, url) {
        var cell = document.createElement(type);
        classes.forEach(function(item){
            cell.classList.add(item);
        });

        var a = document.createElement("a");
        a.target = target;
        a.href = url;

        var textNode = document.createTextNode(text);

        a.appendChild(textNode);
        cell.appendChild(a);
        row.appendChild(cell);

        return cell;
    }

</script>

<div id="tour-results">
    <h2>
        {{tour.name}}
    </h2>
    <table class="table table-striped" style="display:none;">
        <thead>
            <tr>
                <th class="top">{% trans "Position" %}</th>
                <th class="top">{% trans "Player" %}</th>
                <th class="top">{% trans "Points" %}</th>
                {% if not request.user_agent.is_mobile %}
                    {% for tournament in tournaments %}
                        {% if tournament.url %}
                            <th><a href="{{tournament.url}}" target="_blank">{{tournament|ts_number}}</a></th>
                        {% else %}
                            <th>{{tournament|ts_number}}</th>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}