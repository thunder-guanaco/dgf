{% load sekizai_tags static i18n dgf dgf_cms %}

{% addtoblock "css" %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/tour_results.css' %}">
{% endaddtoblock %}

{% with instance.tour as tour %}
{% with tour.tournaments.all|order_by:"begin" as tournaments %}
{% with tour|all_results as results %}
{% with results|all_friends as all_friends %}

{% comment %} This piece of HTML code is just generated to be appended in other places {% endcomment %}
{% for friend in all_friends %}
    <div id="friend-ball-{{friend.id}}" style="display:none;">
        {% include "dgf/includes/friend_ball.html" with friend=friend show_name=True %}
    </div>
{% endfor %}

<script>
    $(window).on("load", function() {
        console.log("Generating results table...");
        friends = parseData();
        generateTable(friends);
        console.log("Results table was generated");
    });

    function parseData() {
        friends = [
        {% for result in results %}
            {
                id: {{result.friend}},
                results: getBestResults({{result|json|safe}}, {{tour.evaluate_how_many}})
            },
        {% endfor %}
        ];
        friends.sort(function(a, b) {
            return b.results.total - a.results.total;
        });
        return friends;
    }

    function getBestResults(results, amount) {

        var sortable = [];
        for (var key in results) {
            if (key.startsWith("points_")) {
                sortable.push([key, results[key]]);
            }
        }
        sortable.sort(function(a, b) {
            return negativeIfNull(b[1]) - negativeIfNull(a[1]);
        });

        var bestResults = {}
        var total = 0;
        sortable.forEach(function(item, index){
            if (item[1] == null) {
                value = '-';
            }
            else if (index < amount) {
                value = item[1];
                total += item[1];
            }
            else {
                value = "[" + item[1] + "]";
            }
            bestResults[item[0]] = value;
        })
        bestResults.total = total;
        return bestResults;
    }

    function negativeIfNull(x) {
        return x == null ? -1 : x;
    }

    function generateTable(friends) {
        var tbody = document.getElementsByTagName("tbody")[0];

        friends.forEach(function(friend, index) {

            var row = document.createElement("tr");

            addCell(row, "th", index + 1);
            addFriendBall(row, "th", friend.id);

            {% if request.user_agent.is_mobile %}
                cell = addCell(row, "th", friend.results.total);
                cell.classList.add("link");
                cell.onclick = function () {
                    $(this).parent().next().toggleClass("hidden");
                    $(this).parent().next().next().toggleClass("hidden");
                };

            {% else %}
                addCell(row, "th", friend.results.total);

                // tournament results for DESKTOP
                {% for tournament in tournaments %}
                    addCell(row, "td", friend.results.points_{{tournament.id}});
                {% endfor %}
            {% endif %}

            tbody.appendChild(row);

            // tournament results for MOBILE
            {% if request.user_agent.is_mobile %}

                var header_row = document.createElement("tr");
                var points_row = document.createElement("tr");

                header_row.classList.add("tournament-results-row");
                points_row.classList.add("tournament-results-row");
                header_row.classList.add("hidden");
                points_row.classList.add("hidden");

                {% for tournament in tournaments %}
                    addCell(header_row, "th", "{{tournament|ts_number}}");
                    addCell(points_row, "td", friend.results.points_{{tournament.id}});
                {% endfor %}

                tbody.appendChild(header_row);
                tbody.appendChild(points_row);

            {% endif %}

        });
        $("table").fadeIn(500);
    }

    function addCell(row, type, text) {
        var cell = document.createElement(type);
        textNode = document.createTextNode(text);
        cell.appendChild(textNode);
        row.appendChild(cell);
        return cell;
    }

    function addFriendBall(row, type, friend_id) {
        var cell = document.createElement(type);
        ball = $("#friend-ball-" + friend_id)[0];
        $(ball).show();
        cell.appendChild(ball);
        row.appendChild(cell);
        return cell;
    }

</script>

<div id="tour-results">
    <h2>
        {{tour.name}}
    </h2>
    <h3>
        ({{tour.begin|date:"SHORT_DATE_FORMAT"}} - {{tour.end|date:"SHORT_DATE_FORMAT"}})
    </h3>
    <table class="table table-striped" style="display:none;">
        <thead>
            <tr>
                <th>{% trans "Position" %}</th>
                <th>{% trans "Player" %}</th>
                <th>{% trans "Points" %}</th>
                {% if not request.user_agent.is_mobile %}
                    {% for tournament in tournaments %}
                        <th>{{tournament|ts_number}}</th>
                    {% endfor %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}