{% load sekizai_tags static i18n dgf dgf_cms %}

{% with instance.tour as tour %}
{% with tour.tournaments.all|order_by:"begin" as tournaments %}
{% with tour|all_results as results %}
{% with results|all_friends as all_friends %}
{% with tournaments.count|minimum:12 as amount_of_tournaments %}
{% with 100|divided_by:amount_of_tournaments|safe as tournament_column_width %}

{% comment %} This piece of HTML code is just generated to be appended in other places {% endcomment %}
{% for friend in all_friends %}
    <div id="friend-ball-{{friend.id}}" style="display:none;">
        {% include "dgf/includes/friend_ball.html" with friend=friend show_name=True %}
    </div>
{% endfor %}

{% addtoblock "css" %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/tour_results.css' %}">
    <style>
        #tour-results .table .details .line .results-wrapper {
            min-width: {{tournament_column_width}}%;
        }
        {% if tournaments.count > 12 %}
            #tour-results .table .details {
                overflow-x: scroll;
                position: relative;
            }
            #tour-results .table {
                position: relative;
            }

            #tour-results .table .details-fade-out {
                top: 0;
                right: 0;
                width: 10%;
                height: 100%;
                background: linear-gradient(to right, rgba(255,255,255,0) 0%,rgba(255,255,255,1) 100%);
                position: absolute;
            }
        {% endif %}
    </style>
{% endaddtoblock %}

{% addtoblock "js" %}
    <script type="text/javascript" src="{% static 'js/tour_results.js' %}"></script>
    <script>
        $(window).on("load", function() {
            console.log("Generating results table...");
            friends = parseData();
            generateTable(friends);
            console.log("Results table was generated");
        });

        function parseData() {
            friends = [
            {% for friend_results in results %}
                {
                    id: {{friend_results.friend}},
                    results: getBestResults({{friend_results|json|safe}}, {{tour.evaluate_how_many}})
                },
            {% endfor %}
            ];
            friends.sort(function(a, b) {
                return b.results.total - a.results.total;
            });
            return friends;
        }

        function generateTable(friends) {
            var summaryPart = $("#tour-results .table .summary")[0];

            friends.forEach(function(friend, index) {

                var summaryRow = addElement(summaryPart, "div", ["line"]);

                addElement(summaryRow, "div", ["position"], index + 1);
                addFriendBall(summaryRow, "div", ["player"], friend.id);

                // MOBILE
                {% if request.user_agent.is_mobile %}
                    cell = addElement(summaryRow, "div", ["points", "link"], friend.results.total);
                    cell.onclick = function () {
                        $(this).parent().next().toggleClass("hidden");
                        $(this).parent().next().next().toggleClass("hidden");
                    };

                // DESKTOP
                {% else %}
                    addElement(summaryRow, "div", ["points"], friend.results.total);

                    var detailsPart = $("#tour-results .table .details")[0];
                    var detailsRow = addElement(detailsPart, "div", ["line"]);

                    {% for tournament in tournaments %}
                        result = friend.results[{{tournament.id}}]
                        var resultsWrapper = addElement(detailsRow, "div", ["results-wrapper"]);
                        addElement(resultsWrapper, "div", ["result", "position-" + result.position], result.points);
                    {% endfor %}


                {% endif %}

                // MOBILE
                {% if request.user_agent.is_mobile %}

                    var detailsRow = addElement(summaryPart, "div", ["details", "hidden"]);
                    addElement(summaryPart, "div", ["details-fade-out", "hidden"]);
                    var headerRow = addElement(detailsRow, "div", ["line", "header"]);
                    var pointsRow = addElement(detailsRow, "div", ["line"]);

                    {% for tournament in tournaments %}
                        var headerWrapper = addElement(headerRow, "div", ["results-wrapper"]);
                        {% if tournament.url %}
                            addElement(headerWrapper, "div", ["result"], "{{tournament|ts_number_mobile}}", "{{tournament.url}}", "_blank");
                        {% else %}
                            addElement(headerWrapper, "div", ["result"], "{{tournament|ts_number_mobile}}");
                        {% endif %}
                        result = friend.results[{{tournament.id}}]
                        var resultsWrapper = addElement(pointsRow, "div", ["results-wrapper"]);
                        addElement(resultsWrapper, "div", ["result", "position-" + result.position], result.points);
                    {% endfor %}
                    addElement(headerRow, "div", ["results-wrapper", "empty"]);
                    addElement(pointsRow, "div", ["results-wrapper", "empty"]);

                {% endif %}

            });
            $("#tour-results .table").fadeIn(500);
        }
    </script>
{% endaddtoblock %}

<div id="tour-results">
    <h2>
        {{tour.name}}
    </h2>
    <div class="table" style="display:none;">
        <div class="summary">
            <div class="line header">
                <div class="position">{% trans "Position" %}</div>
                <div class="player">{% trans "Player" %}</div>
                <div class="points">{% trans "Points" %}</div>
            </div>
        </div>
        {% if not request.user_agent.is_mobile %}
            <div class="details">
                <div class="line header">
                    {% for tournament in tournaments %}
                        <div class="results-wrapper tournament-tooltip">
                            {% if tournament.url %}
                                <a href="{{tournament.url}}" target="_blank">{{tournament|ts_number}}</a>
                            {% else %}
                                {{tournament|ts_number}}
                            {% endif %}
                            <span class="tooltip-text">
                                <span>{{tournament.name}}</span>
                                <br>
                                <span class="tooltip-smaller-text">{{tournament.date}}</span>
                            </span>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="details-fade-out"></div>
        {% endif %}
    </div>
</div>

{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}